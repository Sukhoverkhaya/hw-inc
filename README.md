# Правила работы с конструктором заключения V.2 #

## Правила заполнения редактируемых файлов ##

В текущей версии приложения используется три файла, доступных к редактированию пользователем: `phrase-src.yaml`, `param_list.yaml` и `NormTables.txt`.
Все описанные файлы содержатся в папке settings, находящейся в одной директории с испольняемым файлом приложения helper-gui.exe.

**Что может быть изменено/добавлено в GUI посредством редактирования описанных файлов:**
1. Разделы и фразы.
2. Текст фразы, отображаемый ва меню и в заключении при выборе из меню.
3. Запрещабщие комбинации и условия подсветки каждой фразы.
4. Параметры, вводимые вручную, а также интерфейс для их ввода, имя и тип данных.
5. Нормативные таблицы, формирующие запреты по комбинациям значений параметров.
6. Формулы расчета параметров.

Общие правила оформления файлов типа yaml можно прочитать по [ссылке](https://gist.github.com/sairus7/7690f55c492354e1f8108d896ff11ebe). Подробнее о редактировании каждого из перечисленных файлов будет написано ниже.

### Правила оформления файла с диагнозами и ограничениями `phrase-src.yaml` ###

**Зачем изменять файл:**
* Для добавления и/или удаления разделов и фраз.
* Для добавления новых запрещающих комбинаций и условий подсветки для фраз.
* Для изменения шаблонов.

Помимо общих правил оформления файлов формата yaml, которые можно прочесть по [ссылке](https://gist.github.com/sairus7/7690f55c492354e1f8108d896ff11ebe), для работы с файлом диагнозов и ограничений нужно знать следующие правила:

**1.  Компоненты раздела:**
- ***key*** -       ключ раздела, который используется в системе [шаблонов](https://github.com/IncartDev/std-ecg-report/blob/main/README.md#%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2).
- ***elements*** -  все фразы, входящие в текущий раздел.

**2.  Компоненты фразы:**
- ***name*** -      текст диагноза (фразы), который будет отображаться в гуи.
- ***phrase*** -    текст, который будет добавлен в заключение при выборе из меню фразы с именем ***name*** (может включать систему шаблонов, о которой можно прочесть [здесь](https://github.com/IncartDev/std-ecg-report/blob/main/README.md#%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2).
- ***self-ban*** -      запреты, действующие на текущий элемент (те, при актуальности которых фраза не будет отображаться в меню выбора). Множественные запреты указываются в квадратных скобках, например: self-ban: ["A", "B", "C"].
- ***imposed-ban*** -   запреты, формируемые при выборе элемента (те, которые станут актуальными при выборе данной фразой, и могут приниматься другими фразами в поле ***self-ban***). Поле может содержать только один (уникальный) ключ запрета.
- ***light***-          приоритет (подсветка или выбор по умолчанию), действующий на текущий элемент. Поле может сожержать только где-то ранее определённый ключ(и).

> Обязательным для фразы является только поле ***name*** - остальные могут быть добавлены по мере необходимости.

### Правила оформления файла с конфигурации `param_list.yaml` ###

**Файл определяет:**
* Вид раздела "Добавить параметры".
* Ключи, по которым можно можно обращаться к значениям параметров в системе шаблонов или нормативных таблицах.
* Типы вводимых параметров.
* Интерфейс ввода параметров.

**Зачем изменять файл:**
* Для добавления новых параметров, которые можно вводить вручную или рассчитывать с использованием формул из других введённых параметров.
* Для определения или изменения формата ввода параметров.
* Для изменения формул расчета параметров, для которых они используются.
* При добавлении новой нормотивной таблицы нужно определить оцениваемые в ней параметры, если они не были определены ранее, описав их в данном файле.

Перед работой можно при необходимости ознакомиться с общими правилами оформления файлов формата yaml, которые можно прочесть по [ссылке](https://gist.github.com/sairus7/7690f55c492354e1f8108d896ff11ebe).

Каждый блок в данном файле является описанием параметра и интерфейса для его ввода. Каждый такой элемент содержит поля, общие для всех элементов и описывающие сам параметр, и поля, описывающие ограниченный набор возможных интерфейсов ввода данного параметра.

**1. Поля, общие для всех элементов и описывающие сам параметр:**
- ***name*** -  ключ параметра, по которому к нему можно обращаться в системе шаблонов, использующейся в файле phrase_src.yaml, и в нормативных таблицах, содержащихся в файле NormTables.txt.
- ***text*** -  текст, содержащий осмысленное имя параметра, который будет отображаться в GUI рядом с элементом его ввода.
- ***units*** - один из поддерживаемых типов параметров (описаны [здесь]: ).
- ***guiStyle*** - один из поддерживаемых вариантов интерфейса ввода параметров (описаны ниже, в пункте 2). *Важно учитывать, что не все типы параметров могут быть использованы с определённым вариантами интерфейса ввода, что также будет описано в следующем пункте. То есть, поддерживаются не любые комбинации значений полей - ***units*** и ***guiStyle***.

**2. Поля, зависящие от выбранного элемента ввода (содержимого поля ***guiStyle***)**

- ***variable_text*** - поле перечисления элементов для выбора. Может быть добавлено только в элементы, содержащие ***guiStyle: "ComboBox"*** и ***guiStyle: "RadioButton"*** (элементы, подразумевающие выбор заведомо известных значений).
Поле заполяется значениями следующего формата: 
```
variable_text: [key1: "text1", key2: "text2", key3: "text3"]
```
Значения text1, text2 и text3 будут отображаться в гуи как варианты для выбора. Когда выбор будет сделан, элемент вернёт ключ, состоящий из содержимого поля name данного элемента и соответсвующего выбранному значению ключа (key1, key2 или key3). Таким образом, прописав элемент вида:

```
- {name: Sex,     text: "Пол:",                   guiStyle: "RadioButton",    units: "String", variable_text: [   Male: "Мужчина", 
                                                                                                                    Female: "Женщина"]}
```                                                                                                  
Мы получим в интерфейсе GUI радиокнопки с вариантами "Мужчина" и "Женщина". Выбрав "Мужчина", мы сформируем запрет Sex.Male, а выбрав "Женщина" - Sex.Female. Зпрет может быть использован в таком формате напрямую в файлах диагнозов и ограничений и/или отправлен в сооветсвующую нормативную таблицу (таблицы) для формирования запрета по комбинациям параметров.

- ***guiStyle: "InputInt"*** - элемент ввода числовго значения вручную. Поле ***units*** для этого элемента может содержать только значение Number.
```
Пример создания такого элемента: - {name: HR,      text: "ЧСС:",                   guiStyle: "InputInt",       units: "Number"}
```
- ***guiStyle: "ComboBox"*** - выпадающий список заранее заданных элементов для выбора. Такой элемент всегда должен содержать поле  ***variable_text*** с перечислением всех доступных для выбора значений.
Поле ***units*** для этого элемента может содержать только значение Number и String.
```
Пример создания такого элемента: - {name: Trans,   text: "Переходная зона:",       guiStyle: "ComboBox",  units: "String", variable_text: [ ..V1: "..V1", 
                                                                                                                                                V1: "V1", 
                                                                                                                                                V1-V2: "V1-V2", 
                                                                                                                                                V2: "V2", 
                                                                                                                                                V2-V3: "V2-V3", 
                                                                                                                                                V3: "V3", 
                                                                                                                                                V3-V4: "V3-V4", 
                                                                                                                                                V4: "V4", 
                                                                                                                                                V4-V5: "V4-V5", 
                                                                                                                                                V5: "V5", 
                                                                                                                                                V5-V6: "V5-V6", 
                                                                                                                                                V6..: ">V6"]}
```
- ***guiStyle: "RadioButton"*** - кнопки с заранее заданными вариантами для выбора. Такой элемент всегда должен содержать поле  ***variable_text*** с перечислением всех доступных для выбора значений.
Поле ***units*** для этого элемента может содержать только значение Number и String.
```
Пример создания такого элемента: - {name: Sex,     text: "Пол:",                   guiStyle: "RadioButton",    units: "String", variable_text: [  Male: "Мужчина",                                                                                                                                                 Female: "Женщина"]}
```
- ***guiStyle: "CalcResult"*** - недоступное для редактирования поля для отображения результата расчета параметра по указанной формуле. Поле ***units*** для этого элемента может содержать только значение Number.
Поле ***formula*** допустимо только для этого элемента и содержит формулу для расчета данногог параметра.
```
Пример создания такого элемента: - {name: pcRRdiv, text: "% RR мин.: ", guiStyle: "CalcResult", units: "Number", formula: ((RRmax - RRmin) / RRmean)*100}
```
**Правила заполнения поля ***formula***:**
* Формула может содержать только операторы +, -, /, *, ^ и скобки () (извлечение квадратного корня аналогично возведению в степень 0.5, поэтому может быть записано как 4 ^ 0.5 или 4 ^ (1/2)).
* Формула может содержать ключи других параметров, которые должны быть использованы в расчётах (ключ параметра лежит в поле ***name*** его элемента). Важно, чтобы используемый в формуле ключ отсылал к существующему (описанному ВЫШЕ в том же документе) параметру, а содержимое поля ***units*** элемента по данному ключу содержало строго Number или Age (т.к. в формуле могут быть использованы только числа).
* Десятичная форма записи числа допустима только через точку, например: 15.2
* Формула должна быть уравновешенной, то есть содержать раное количество открывающих и закрывающих скобок и значения (или выражения, вычисления которых дают значения) по обе стороны от математических операторов

### Правила оформления файла с нормативными таблицами `NormTables.txt` ###

Данный файл содержит все нормативные таблицы, формирующие запреты по полученной комбинации значений. Таблицы имеют вид:

```
QTc                                key2 - это ключ параметра 2, значения поторого содержатся во всех ячейках таблицы, кроме первого столбца (и имён столбцов)
Sex: Female                        key0: value - это ключ параметра 0 и его значение
Age;	Short;	Norm;	Long         key1; запрет1; запрет2; запрет3 - это имена столбцов. Имя первого столбца - всегда ключ параметра, значения которого содержатся в этом столбце, остальное - запреты, возвращаемые попаданием в данный столбец
..18y;	..320;	..440;	..                                                                                                                                             
..;	    ..340;	..460;	..
```

- Группирующий параметр key0: value необязательный (может не быть указан в таблице), остальные - обязательны.
- Все ключи key, используемые в талицах, должны быть прописаны в файле param_list.yaml. Они должны соответствовать содержимому поля name используемых в таблице параметров.
- Все значения будут интерпретированы в тип данных, указаный (в файле param_list.yaml) по ключу, которому они соответсвую в таблице.
Например, файл param_list.yaml содержит следующие записи:
```
- {name: Sex,     text: "Пол:",                   guiStyle: "RadioButton",    units: "String", variable_text: [   Male: "Мужчина", 
                                                                                                                    Female: "Женщина"]}
- {name: QTc, text: "Корригированный QT: ", guiStyle: "CalcResult", units: "Number", formula: QT / HR ^ 0.5}
- {name: Age, text: "Дата рождения: ", guiStyle: "Calendar", units: "Age"}
```
**Обращаем внимание на содержимое полей Name и соответсвующее им содержимое полей units.**

В указанной в качестве примера нормотивной таблице по ключу Sex: указано значение Female - согласно информации из param_list, оно будет интерпретировано как текст.
По ключу Age указаны значения в формкте "..18; ..", которые будут интерпретированы как Age, потому что такой формат соответсвует параметру Age согласно param_list.
По ключу Qtc указаны значения в формате "..320; ..440; ..", которые будут интерпретированы как Number, потому что такой формат соответсвует параметру Age согласно param_list.

>  Формат, в который будут интерпретированы значения, важно знать и учитывать, потому что от него напрямую зависит способ анализа таблицы - подробнее об этом рассказывает раздел "О поддерживаемых типах данных".

Таким образом, если в первый столбец таблицы, в котором указаны значения по ключу Age, были бы записаны любые символы, кроме цифр, d/m/y и .., мы получали бы ошибку, так как такие значения не могут быть интерпретированы в возраст. То же актуально и для остальных значений в таблице, которые, будучи связанными с ключом QTc, должны интерпретироваться в тип Number, в который не получится перевести буквы и/или другие символы, кроме цифр, d/m/y и .. .
В то же время, если бы в поле Sex, интерпретируемое в Sting, было бы записано значение вида "3d..18y", вместо диапазона возраста мы получили бы просто строку "3d..18y", которая не дала бы ошибку, но не совпала бы ни с "Male" ни с "Female" - следовательно, таблица никогда не была бы использована.

________
**Поиск по таблице происходит по следующему алгоритму:**
- Если в param_list есть параметр с ключом, совпадающим с key2 - данна таблица выбирается для оценки.
- Проверка группирующих параметров: по ключам key0 берётся введённое значение и сравнивается с указанным в таблице. Если хотя бы один группирующий параметр не совпадает с введённым (или не попадает в диапазон) - таблица не используется.
- Если таблица выбрана по имени и группирующим параметрам, начинается поиск по значениям первого столбца: по ключу key1 берётся значение из введённых, и в соответсвии с типом данных, привязанным к ключу, производится поиск строки, в которую
"пападает" введённое значение.
- После выбора строки, поиск по остальным стобцам в ней производится по значению введённого параметра, взятому по ключу key2, по правилам, описанным в предыдущем пункте.
- Имя столбца, в котором найдено соответсвие - ключ запрета.
- Таблица возвращает запрет в формате ИмяТаблицы.ИмяСтолбца. Например, для таблицы выше, это могут быть запреты QTc.Short, QTc.Norm, QTc.Long.

## Примеры наиболее вероятных сценариев использования ## 
